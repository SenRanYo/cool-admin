import{d as ee}from"./dayjs-98968027.js";import{l as H,u as O,i as te,f as W,m as se}from"./index-e77a39a7.js";import"./store-4dd21bbb.js";import{u as oe}from"./index-8d3b4b42.js";import{J as ne,a2 as ae,a3 as le,a4 as ce,B as ie,R as re,a5 as ue,a6 as de,m as _e}from"./@element-plus.icons-vue-e3809a99.js";import{y as pe,d as z,q,W as r,_ as K,K as L,o as h,c as $,a as e,F as E,b as t,M as Y,J as l,U as A,N as me,I as J,n as fe,z as ve}from"./@vue.runtime-core-3a9e54b6.js";import{d as G}from"./pinia-2b0aea45.js";import{r as w,u as s}from"./@vue.reactivity-747ae439.js";import{i as he}from"./@vueuse.core-b5ce6112.js";import{a as ge}from"./element-plus-aceaa6a8.js";import{O as I,o as R}from"./@vue.shared-9aa0355e.js";import{_ as P}from"./_plugin-vue_export-helper-c27b6911.js";import{d as xe}from"./lodash-es-d00cf236.js";import"./chardet-ee49d9b4.js";import"./@vue.runtime-dom-7b7b8a44.js";import"./monaco-editor-9ddaeaf3.js";import"./axios-aba6f0e0.js";import"./nprogress-d2c1a460.js";import"./mitt-b509fb6d.js";import"./vue-router-19ed6b98.js";import"./vue-echarts-c84fbe77.js";import"./resize-detector-a5205554.js";import"./echarts-90e4e057.js";import"./tslib-54e39b60.js";import"./zrender-5c8f9fce.js";import"./mockjs-5923ee6a.js";import"./vue-1fcee0a5.js";import"./@vueuse.shared-8ce56883.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-384ef2e5.js";import"./async-validator-dee29e8b.js";import"./memoize-one-297ddbcb.js";import"./escape-html-1d60d822.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-a30dd394.js";import"./@floating-ui.core-a4bcb9d9.js";import"./vue-demi-71ba0ef2.js";function Q(){return{chat:pe("chat")}}const ye=G("chat-message",()=>{const g=w(!1),f=w([]),u=w({page:1,total:0,size:20});async function n(c){g.value=!0,(c==null?void 0:c.page)==1&&(f.value=[]),await H.chat.message.page(c).then(d=>{f.value=d.list.map(o=>(o.content=JSON.parse(o.content),o)),u.value=d.pagination}),g.value=!1}return{loading:g,list:f,pagination:u,get:n}}),ke=G("chat-session",()=>{const g=w(!1),f=w([]),u=w();async function n(d){g.value=!0,await H.chat.session.page(d).then(o=>{u.value||c(o.list[0]),f.value=o.list}),g.value=!1}function c(d){u.value=d}return{loading:g,list:f,value:u,get:n,set:c}});function j(){const g=ke(),f=ye();return{session:g,message:f}}const be={class:"chat-message","element-loading-text":"消息列表加载中"},Ce={class:"head"},$e={class:"avatar"},we={class:"name"},Me={class:"avatar"},Se=["onContextmenu"],Te={class:"h"},Ve={class:"name"},Ne={class:"content"},Be={key:0,class:"is-text"},Ie={key:1,class:"is-image"},ze={class:"footer"},Ue={class:"tools"},De={class:"input"},qe=z({name:"undefined"}),Ee=z({...qe,setup(g){const{user:f}=O(),{chat:u}=Q(),{message:n,session:c}=j(),{copy:d}=he(),o=w(""),M=q(()=>{let _=0;return n.list.map(a=>{var y;return a.contentType==1&&(a._index=_++),a.isMy=a.fromId==((y=f.info)==null?void 0:y.id),a})}),v=q(()=>n.list.filter(_=>_.contentType==1).map(_=>{var a;return(a=_.content)==null?void 0:a.imageUrl}).filter(Boolean));function x(){u.send({contentType:0,content:{text:o.value}},!0),o.value=""}function U(_){u.send({contentType:1,content:{imageUrl:_.url}},!0),o.value=""}function V(_,a){te.ContextMenu.open(_,{hover:{target:"content"},list:[{label:"复制",callback(y){d(a.content.text||""),ge.success("复制成功"),y()}},{label:"转发"},{label:"删除"}]})}return(_,a)=>{var S,T,B,F;const y=r("cl-avatar"),D=r("el-image"),N=r("el-scrollbar"),k=r("el-icon"),p=r("cl-upload"),m=r("el-input"),i=r("el-button"),b=K("loading");return L((h(),$("div",be,[e("div",Ce,[(S=s(c))!=null&&S.value?(h(),$(E,{key:0},[e("div",$e,[t(y,{size:30,shape:"square",src:(T=s(c))==null?void 0:T.value.avatar},null,8,["src"])]),e("span",we,"与“"+I((B=s(c))==null?void 0:B.value.nickName)+"”聊天中",1)],64)):Y("",!0)]),t(N,{class:"list"},{default:l(()=>[e("ul",null,[(h(!0),$(E,null,A(s(M),(C,X)=>(h(),$("li",{key:X},[e("div",{class:R(["item",{"is-right":C.isMy}])},[e("div",Me,[t(y,{size:36,shape:"square",src:C.avatar},null,8,["src"])]),e("div",{class:"det",onContextmenu:Z=>{V(Z,C)}},[e("div",Te,[e("span",Ve,I(C.nickName),1)]),e("div",Ne,[C.contentType==0?(h(),$("div",Be,[e("span",null,I(C.content.text),1)])):C.contentType==1?(h(),$("div",Ie,[t(D,{src:C.content.imageUrl,"preview-src-list":s(v),"initial-index":C._index,"scroll-container":".chat-message .list"},null,8,["src","preview-src-list","initial-index"])])):Y("",!0)])],40,Se)],2)]))),128))])]),_:1}),e("div",ze,[e("div",Ue,[e("ul",null,[t(p,{onSuccess:U,"show-file-list":!1},{default:l(()=>[e("li",null,[t(k,null,{default:l(()=>[t(s(ne))]),_:1})])]),_:1}),e("li",null,[t(k,null,{default:l(()=>[t(s(ae))]),_:1})]),e("li",null,[t(k,null,{default:l(()=>[t(s(le))]),_:1})]),e("li",null,[t(k,null,{default:l(()=>[t(s(ce))]),_:1})])])]),e("div",De,[t(m,{modelValue:o.value,"onUpdate:modelValue":a[0]||(a[0]=C=>o.value=C),type:"textarea",rows:4,resize:"none",autosize:{minRows:4,maxRows:10},placeholder:"输入内容"},null,8,["modelValue"]),t(i,{type:"success",onClick:x,disabled:!o.value},{default:l(()=>[me("发送")]),_:1},8,["disabled"])])])])),[[b,(F=s(n))==null?void 0:F.loading]])}}});const Ye=P(Ee,[["__scopeId","data-v-fc3d1622"]]),Je={class:"chat-session"},Re={class:"head"},je={class:"tools"},Fe={class:"list"},He=["onClick"],Oe={class:"avatar"},We={class:"det"},Ke={class:"name"},Le={class:"message"},Ae={class:"status"},Ge={class:"date"},Pe=z({name:"undefined"}),Qe=z({...Pe,setup(g){const{browser:f}=W(),{chat:u}=Q(),{session:n,message:c}=j(),d=w(""),o=q(()=>(n==null?void 0:n.list.filter(v=>{var x;return(x=v.nickName)==null?void 0:x.includes(d.value)}))||[]);async function M(v){f.isMini&&u.expand(!1),n.set(v),await c.get({page:1}),u.scrollToBottom()}return(v,x)=>{var k;const U=r("el-input"),V=r("el-icon"),_=r("cl-avatar"),a=r("el-badge"),y=r("el-empty"),D=r("el-scrollbar"),N=K("loading");return h(),$("div",Je,[e("div",Re,[t(U,{modelValue:d.value,"onUpdate:modelValue":x[0]||(x[0]=p=>d.value=p),placeholder:"关键字搜索",clearable:""},null,8,["modelValue"]),e("ul",je,[e("li",null,[t(V,null,{default:l(()=>[t(s(ie))]),_:1})]),e("li",{onClick:x[1]||(x[1]=p=>s(n).get())},[t(V,null,{default:l(()=>[t(s(re))]),_:1})])])]),L((h(),$("div",Fe,[t(D,{class:"scroller"},{default:l(()=>[(h(!0),$(E,null,A(s(o),(p,m)=>{var i,b;return h(),$("div",{class:R(["item",{"is-active":p.id==((b=(i=s(n))==null?void 0:i.value)==null?void 0:b.id)}]),key:m,onClick:S=>M(p)},[e("div",Oe,[t(a,{value:p.num,hidden:p.num==0},{default:l(()=>[t(_,{shape:"square",src:p.avatar},null,8,["src"])]),_:2},1032,["value","hidden"])]),e("div",We,[e("p",Ke,I(p.nickName),1),e("p",Le,I(p.text),1)]),e("div",Ae,[e("p",Ge,I(p.createTime),1)])],10,He)}),128)),s(o).length==0?(h(),J(y,{key:0,"image-size":100,description:"暂无会话"})):Y("",!0)]),_:1})])),[[N,(k=s(n))==null?void 0:k.loading]])])}}});const Xe=P(Qe,[["__scopeId","data-v-e7afd515"]]),Ze={class:"cl-chat__wrap"},et={class:"cl-chat__session"},tt={class:"cl-chat__right"},st={class:"cl-dialog__controls-icon"},ot=z({name:"cl-chat"}),jt=z({...ot,setup(g,{expose:f}){oe();const{browser:u,onScreenChange:n}=W(),{session:c,message:d}=j(),{user:o}=O();se.get("chat");const M=w(!1),v=w(!0),x=w(parseInt(String(Math.random()*100)));let U;function V(){p()}function _(){M.value=!0,V()}function a(){M.value=!1}function y(m){v.value=m===void 0?!v.value:m}function D(m,i){i&&N(m)}function N(m){var i,b,S,T;d.list.push({fromId:(i=o.info)==null?void 0:i.id,toId:(b=c.value)==null?void 0:b.userId,avatar:(S=o.info)==null?void 0:S.headImg,nickName:(T=o.info)==null?void 0:T.nickName,createTime:ee().format("YYYY-MM-DD HH:mm:ss"),...m}),k()}const k=xe(()=>{fe(()=>{const m=document.querySelector(".cl-chat .chat-message .list");m==null||m.scroll({top:1e5+Math.random(),behavior:"smooth"})})},300);async function p(){await c.get(),await d.get(),k()}return ve("chat",{get socket(){return U},send:D,append:N,expand:y,scrollToBottom:k}),n(()=>{v.value=!u.isMini}),f({open:_,close:a}),(m,i)=>{const b=r("el-icon"),S=r("el-badge"),T=r("cl-dialog");return h(),$("div",Ze,[e("div",{class:"cl-chat__icon",onClick:_},[t(S,{value:x.value},{default:l(()=>[t(b,{size:15},{default:l(()=>[t(s(ue))]),_:1})]),_:1},8,["value"])]),t(T,{modelValue:M.value,"onUpdate:modelValue":i[2]||(i[2]=B=>M.value=B),title:"聊天窗口",height:"630px",width:"1200px","keep-alive":"","close-on-click-modal":!1,"close-on-press-escape":"","append-to-body":"",controls:["slot-expand","cl-flex1","fullscreen","close"]},{"slot-expand":l(()=>[e("button",st,[v.value?(h(),J(b,{key:1,onClick:i[1]||(i[1]=B=>v.value=!1)},{default:l(()=>[t(s(_e))]),_:1})):(h(),J(b,{key:0,onClick:i[0]||(i[0]=B=>v.value=!0)},{default:l(()=>[t(s(de))]),_:1}))])]),default:l(()=>[e("div",{class:R(["cl-chat",{"is-mini":s(u).isMini,"is-expand":v.value}])},[e("div",et,[t(Xe)]),e("div",tt,[t(Ye)])],2)]),_:1},8,["modelValue"])])}}});export{jt as default};
