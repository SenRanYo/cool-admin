import{k as S,u as ee,i as te}from"./index-e77a39a7.js";import{i as oe}from"./@vueuse.core-b5ce6112.js";import{m as se}from"./mqtt-b64b1577.js";import"./store-4dd21bbb.js";import{u as j}from"./index-8d3b4b42.js";import{d as ne}from"./dayjs-98968027.js";import{o as ae,d as ie}from"./lodash-es-d00cf236.js";import{a as X}from"./element-plus-aceaa6a8.js";import{d as Y,q as ce,n as L,e as re,f as le,W as u,_ as ue,o as _,I as pe,J as h,a as o,b as p,K as me,c as C,F as de,U as ve,M as _e,N as fe}from"./@vue.runtime-core-3a9e54b6.js";import{u as Ae}from"./hook-471dd008.js";import{r as E,u as m}from"./@vue.reactivity-747ae439.js";import{O as f,o as M}from"./@vue.shared-9aa0355e.js";import{_ as ge}from"./_plugin-vue_export-helper-c27b6911.js";import"./@vue.runtime-dom-7b7b8a44.js";import"./monaco-editor-9ddaeaf3.js";import"./axios-aba6f0e0.js";import"./nprogress-d2c1a460.js";import"./chardet-ee49d9b4.js";import"./mitt-b509fb6d.js";import"./vue-router-19ed6b98.js";import"./pinia-2b0aea45.js";import"./vue-demi-71ba0ef2.js";import"./vue-echarts-c84fbe77.js";import"./resize-detector-a5205554.js";import"./echarts-90e4e057.js";import"./tslib-54e39b60.js";import"./zrender-5c8f9fce.js";import"./mockjs-5923ee6a.js";import"./vue-1fcee0a5.js";import"./@vueuse.shared-8ce56883.js";import"./@element-plus.icons-vue-e3809a99.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-384ef2e5.js";import"./async-validator-dee29e8b.js";import"./memoize-one-297ddbcb.js";import"./escape-html-1d60d822.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-a30dd394.js";import"./@floating-ui.core-a4bcb9d9.js";let s;function he(){const{mitt:q}=j();function d(a,i){s==null||s.publish(a,i)}function v(a){console.log("[iot] mqtt subscribe",a),s==null||s.subscribe(`${a}@admin`,function(i){i&&console.error(i)})}function b(){s=se.connect("ws://127.0.0.1:8083"),S.getData("iotMqttEventLock")||(S.setData("iotMqttEventLock",!0),s&&(s.on("connect",function(){console.log("[iot] mqtt connect")}),s.on("message",function(a,i){q.emit("iot.message",{id:a.split("@")[0],message:i.toString()})}),s.on("error",function(a){console.error(a),s==null||s.reconnect()})))}return{client:s,connect:b,subscribe:v,send:d}}const Z="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAA19JREFUeF7tmcvrTVEUxz/fEv4Bj5RkQEoZCBlIpDxiQt7JQPL6JY/ERHnEQJgoZCDJM68oykD8zA1MUDKRCZmZyWBp6dw6jnPvPWdf19m6ew3vWfusvT77u9Y+d28x4KYBz58EIClgwAmkEhhwAaQmmEoglcCAE0glMOAC6G0XMLNLwAJgakMg3wPDkraHxg8uATOz0KD9GCcpKJegQWZ2FDjSj0R6eOcxST6vWhYK4Bawvlak/jvflrShbphQAC+y2q8br5P/XeAecAKYEvBi7wUL646LCcBCScNmNhpwKR+qmUx0ALYBK4FlFRK5IGko72dmc4FjwOIK490lKgBPJK3wWZnZKmAXsKhNIl+9nCS9LXtuZjuA48CYLiCiArBM0tPCinrT3AnMLyTStXub2TRgL9Bpv48GwCVJvmqlZmabMxAu8TeA176r4JeZ2ThJX9qowSHuA+aUPI8CgE98nqQP3erWzLYCIyVdyCU/CngIPJN0tg2E8cAe4AAwIucTBYDDkk4WpL9J0vVuQLLVPwicynxfA2ck3WgDYilwFRibPW8cwCtJswvJ+07g/xduu3Qlfe5QGrOAR8CEgo/3ktOSnhfefQ7YHZMCVku6n5PzJOAJMD377RuwX9LlNit6DdjUQSlXMhDvzGwJ8FuTbXobvCNpXWGFvIb3lyT0IAPxMQdrC1AKpjD+h5cFMBNwCHlrtAS8kZ1v7eXZCj0uNKn8ZL9nJXHRzCZnjW9GlT7RwadRAD4v38r8i+6omXnyyysk5CXiO4Z39V6tcQCtBHxvb9V9r0nVGR8NgDqT/pu+CcD//ne4VzX8UwX4QWh05ucJdScVdCBSN0jM/kEAzGywFWBm/TgT7FUo/7QHJAB9OBVOCuiRQKMl4NvPy4oJVLlSK97w+Olwy1rjvRHnm3GzAEK+wsqAZTuM95i8/XFwWtKIE4CQRQj9DijuAkH0kwJKCPy3JVCxAVZ1K35ptvvGb6wJ+hGY3/LEZBcl+RVcLQvtAR7ofK1I/Xceyl+yVA0XBMBfbmZ3gDVVA/XZ766ktSExggFkEDYCfkMzMST4Xxjzye8HJN0MfVdPAEKDxjQuAYhpNZqYS1JAE9RjipkUENNqNDGXpIAmqMcUMykgptVoYi5JAU1QjynmT+PCelBN7E0UAAAAAElFTkSuQmCC",Ce={class:"icon"},be={class:"det"},we={class:"name"},ye={class:"text"},xe={class:"message"},ke={class:"icon"},Ee=["onContextmenu"],Me={class:"content"},qe={class:"is-text"},Ve={class:"date"},Be={key:0,class:"empty"},De={class:"footer"},Je={class:"input"},Re=Y({name:"iot-device"}),Te=Y({...Re,setup(q){const{service:d,refs:v,setRefs:b,mitt:a}=j(),{copy:i}=oe(),{user:z}=ee(),V=he(),{ViewGroup:w}=Ae({label:"设备",title:"消息列表",service:d.iot.device,onEdit(e){return{width:"600px",items:[{label:"设备名称",prop:"name",component:{name:"el-input",props:{maxlength:20,clearable:!0}},required:!0},{label:"设备ID",prop:"uniqueId",component:{name:"el-input",props:{maxlength:30,clearable:!0,disabled:!!(e!=null&&e.id)}},required:!0},{label:"设备图标",prop:"icon",component:{name:"cl-upload"}}]}},async onSelect(e){V.subscribe(e.uniqueId),await J({page:1,deviceId:e.id}),R()}}),y=E(!1),r=E(""),l=E([]),B=ce(()=>{var e,t;return(t=(e=w.value)==null?void 0:e.selected)==null?void 0:t.uniqueId}),A={page:1,size:20};let D=!1;async function J(e){y.value=!0,Object.assign(A,{order:"createTime",sort:"desc",...e}),await d.iot.message.page(A).then(t=>{const c=ae(t.list,"createTime");if(A.page==1)l.value=c;else{const g=v.scrollbar.wrapRef.querySelector("ul"),x=g.clientHeight;l.value.unshift(...c),L(()=>{v.scrollbar.scrollTo(0,g.clientHeight-x)})}D=t.pagination.total<=l.value.length}).catch(t=>{X.error(t.message)}),y.value=!1}const R=ie(()=>{L(()=>{var e,t;(t=(e=v.scrollbar)==null?void 0:e.wrapRef)==null||t.scroll({top:1e5+Math.random(),behavior:"smooth"})})});function P({scrollTop:e}){e==0&&!D&&J({page:A.page+1})}function U(){d.iot.mqtt.publish({uniqueId:B.value,data:r.value}).then(()=>{T({data:r.value,type:0}),r.value=""})}function T(e){l.value.push({createTime:new Date,...e}),R()}function G(e,t){te.ContextMenu.open(e,{hover:{target:"content"},list:[{label:"复制",callback(c){i(t.data||""),X.success("复制成功"),c()}}]})}function I({id:e,message:t}){B.value==e&&T({type:1,data:t})}return re(()=>{V.connect(),a.on("iot.message",I)}),le(()=>{a.off("iot.message",I)}),(e,t)=>{const c=u("cl-avatar"),g=u("el-empty"),x=u("el-scrollbar"),F=u("el-input"),H=u("el-button"),W=u("cl-view-group"),O=ue("loading");return _(),pe(W,{ref_key:"ViewGroup",ref:w},{item:h(({item:n,selected:k})=>[o("div",{class:M(["device-item",{"is-active":k.id==n.id}])},[o("div",Ce,[p(c,{shape:"square",src:n.icon||m(Z)},null,8,["src"])]),o("div",be,[o("p",we,f(n.name),1),o("p",ye,f(n.uniqueId),1)]),o("div",{class:M(["status",{"is-on":n.status}])},f(n.status?"在线":"离线"),3)],2)]),right:h(()=>[me((_(),C("div",xe,[p(x,{class:"list",ref:m(b)("scrollbar"),onScroll:P},{default:h(()=>[o("ul",null,[(_(!0),C(de,null,ve(l.value,(n,k)=>{var K,N,Q;return _(),C("li",{key:k},[o("div",{class:M(["item",{"is-right":n.type==0}])},[o("div",ke,[p(c,{size:36,shape:"square",src:n.type==0?(K=m(z).info)==null?void 0:K.headImg:((Q=(N=m(w))==null?void 0:N.selected)==null?void 0:Q.icon)||m(Z)},null,8,["src"])]),o("div",{class:"det",onContextmenu:$=>{G($,n)}},[o("div",Me,[o("span",qe,f(n.data),1)]),o("div",Ve,f(m(ne)(n.createTime).format("YYYY-MM-DD HH:mm:ss")),1)],40,Ee)],2)])}),128))]),l.value.length==0?(_(),C("div",Be,[p(g,{"image-size":100,description:"暂无消息"})])):_e("",!0)]),_:1},512),o("div",De,[o("div",Je,[p(F,{modelValue:r.value,"onUpdate:modelValue":t[0]||(t[0]=n=>r.value=n),type:"textarea",rows:4,resize:"none",autosize:{minRows:4,maxRows:10},placeholder:"输入内容"},null,8,["modelValue"]),p(H,{type:"success",onClick:U,disabled:!r.value},{default:h(()=>[fe("发送")]),_:1},8,["disabled"])])])])),[[O,y.value]])]),_:1},512)}}});const Ct=ge(Te,[["__scopeId","data-v-ebad7f9c"]]);export{Ct as default};
