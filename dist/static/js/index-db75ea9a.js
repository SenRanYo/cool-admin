import{i as N,c as Z,r as ee,e as L}from"./index-e77a39a7.js";import"./store-4dd21bbb.js";import{u as P}from"./index-8d3b4b42.js";import{u as Q}from"./hook-471dd008.js";import{v as te,w as ne}from"./@vue.runtime-dom-7b7b8a44.js";import{R as oe,S as re,E as le}from"./@element-plus.icons-vue-e3809a99.js";import{b as z,a as I}from"./element-plus-aceaa6a8.js";import{r as se}from"./lodash-es-d00cf236.js";import{d as D,e as ae,W as i,_ as X,o as y,c as S,a as C,b as n,J as p,M as K,K as G,N as q,I as E,n as ie,am as pe,al as ce,U as de,F as ue}from"./@vue.runtime-core-3a9e54b6.js";import{r as J,u as v}from"./@vue.reactivity-747ae439.js";import{o as me,O as Y}from"./@vue.shared-9aa0355e.js";import{_ as _e}from"./_plugin-vue_export-helper-c27b6911.js";import"./monaco-editor-9ddaeaf3.js";import"./axios-aba6f0e0.js";import"./nprogress-d2c1a460.js";import"./chardet-ee49d9b4.js";import"./@vueuse.core-b5ce6112.js";import"./@vueuse.shared-8ce56883.js";import"./mitt-b509fb6d.js";import"./vue-router-19ed6b98.js";import"./pinia-2b0aea45.js";import"./vue-demi-71ba0ef2.js";import"./vue-echarts-c84fbe77.js";import"./resize-detector-a5205554.js";import"./echarts-90e4e057.js";import"./tslib-54e39b60.js";import"./zrender-5c8f9fce.js";import"./mockjs-5923ee6a.js";import"./vue-1fcee0a5.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-384ef2e5.js";import"./dayjs-98968027.js";import"./async-validator-dee29e8b.js";import"./memoize-one-297ddbcb.js";import"./escape-html-1d60d822.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-a30dd394.js";import"./@floating-ui.core-a4bcb9d9.js";const fe=x=>(pe("data-v-661dd2cf"),x=x(),ce(),x),be={class:"dept-tree"},he={class:"dept-tree__header"},ve=fe(()=>C("div",null,"组织架构",-1)),ye={class:"dept-tree__op"},ge={class:"no"},we=["onContextmenu"],ke={class:"dept-tree__node"},xe=["onClick"],Ce=["onClick"],Ie=D({name:"dept-list"}),Ne=D({...Ie,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["refresh","user-add"],setup(x,{emit:g}){const F=x,{service:_,browser:$}=P(),{ViewGroup:f}=Q(),w=N.useForm(),u=J([]),b=J(!1),h=J(!1);function W({data:t}){return t.parentId}function s(t,e){return e.data.parentId}async function r(){b.value=!0,h.value=!1,await _.base.sys.department.list().then(t=>{var e;u.value=Z(t),(e=f.value)!=null&&e.selected||c()}),b.value=!1}function c(t){var e;if(t||(t=u.value[0]),t){const l=t.children?ee(t.children).map(o=>o.id):[];l.unshift(t.id),(e=f.value)==null||e.select(t),ie(()=>{g("refresh",{page:1,departmentIds:l})})}}function k(t){var l;const e=t.id?"update":"add";(l=w.value)==null||l.open({title:"编辑部门",width:"550px",props:{labelWidth:"100px"},items:[{label:"部门名称",prop:"name",component:{name:"el-input"},required:!0},{label:"上级部门",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:{...t},on:{submit(o,{done:a,close:m}){_.base.sys.department[e]({id:t.id,parentId:t.parentId,name:o.name,orderNum:o.orderNum}).then(()=>{I.success(`新增部门 “${o.name}” 成功`),m(),r()}).catch(V=>{I.error(V.message),a()})}}},[N.setFocus()])}function O(t){async function e(l){await _.base.sys.department.delete({ids:[t.id],deleteUser:l}).then(()=>{var o,a;((a=(o=f.value)==null?void 0:o.selected)==null?void 0:a.id)==t.id&&c(),l?I.success("删除成功"):z.confirm(`“${t.name}” 部门的用户已成功转移到 “${t.parentName}” 部门。`,"删除成功")}),r()}z.confirm(`此操作将会删除 “${t.name}” 部门的所有用户，是否确认？`,"提示",{type:"warning",confirmButtonText:"直接删除",cancelButtonText:"保留用户",distinguishCancelAndClose:!0}).then(()=>{e(!0)}).catch(l=>{l=="cancel"&&e(!1)})}function B(t){t?z.confirm("部门架构已发生改变，是否保存？","提示",{type:"warning"}).then(async()=>{const e=[];function l(o,a){o.forEach(m=>{m.parentId=a,e.push(m),m.children&&se(m.children)&&l(m.children,m.id)})}l(u.value,null),await _.base.sys.department.order(e.map((o,a)=>({id:o.id,parentId:o.parentId,orderNum:a}))).then(()=>{I.success("更新排序成功")}).catch(o=>{I.error(o.message)}),r(),h.value=!1}).catch(()=>null):r()}function T(t,e,l){e||(e=u.value[0]||{});const o=_.base.sys.department.permission;N.ContextMenu.open(t,{list:[{label:"新增",hidden:l&&l.level>=F.level||!L(o.add),callback(a){k({name:"",parentName:e.name,parentId:e.id}),a()}},{label:"编辑",hidden:!L(o.update),callback(a){k(e),a()}},{label:"删除",hidden:!e.parentId||!L(o.delete),callback(a){O(e),a()}},{label:"新增成员",hidden:!L(o.add),callback(a){g("user-add",e),a()}}]})}return ae(function(){r()}),(t,e)=>{const l=i("el-icon"),o=i("el-tooltip"),a=i("el-button"),m=i("el-tree"),V=i("el-scrollbar"),R=i("cl-form"),U=X("loading");return y(),S("div",be,[C("div",he,[ve,C("ul",ye,[C("li",{onClick:e[0]||(e[0]=d=>r())},[n(o,{content:"刷新"},{default:p(()=>[n(l,null,{default:p(()=>[n(v(oe))]),_:1})]),_:1})]),x.drag&&!v($).isMini?(y(),S("li",{key:0,onClick:e[1]||(e[1]=d=>h.value=!0)},[n(o,{content:"拖动排序"},{default:p(()=>[n(l,null,{default:p(()=>[n(v(re))]),_:1})]),_:1})])):K("",!0),G(C("li",ge,[n(a,{onClick:e[2]||(e[2]=d=>B(!0)),size:"small"},{default:p(()=>[q("保存")]),_:1}),n(a,{onClick:e[3]||(e[3]=d=>B(!1)),size:"small"},{default:p(()=>[q("取消")]),_:1})],512),[[te,h.value]])])]),C("div",{class:"dept-tree__container",onContextmenu:ne(T,["stop","prevent"])},[n(V,null,{default:p(()=>[G((y(),E(m,{"node-key":"id","default-expand-all":"",data:u.value,props:{label:"name"},draggable:h.value,"allow-drag":W,"allow-drop":s,"expand-on-click-node":!1,onNodeContextmenu:T},{default:p(({node:d,data:M})=>{var A,j;return[C("div",ke,[C("span",{class:me(["dept-tree__node-label",{"is-active":M.id==((j=(A=v(f))==null?void 0:A.selected)==null?void 0:j.id)}]),onClick:H=>c(M)},Y(d.label),11,xe),v($).isMini?(y(),S("span",{key:0,class:"dept-tree__node-icon",onClick:H=>T(H,M,d)},[n(l,null,{default:p(()=>[n(v(le))]),_:1})],8,Ce)):K("",!0)])]}),_:1},8,["data","draggable"])),[[U,b.value]])]),_:1})],40,we),n(R,{ref_key:"Form",ref:w},null,512)])}}});const $e=_e(Ne,[["__scopeId","data-v-661dd2cf"]]),Me={class:"dept-move"},We=D({name:"user-move"}),Te=D({...We,setup(x,{expose:g}){const{service:F}=P(),_=N.useForm(),$=N.useCrud();async function f(w){var u;(u=_.value)==null||u.open({title:"部门转移",width:"500px",props:{labelWidth:"80px"},items:[{label:"选择部门",prop:"departmentId",component:{name:"cl-dept-select"}}],on:{submit(b,{done:h,close:W}){if(!b.departmentId)return I.warning("请选择部门"),h();z.confirm("转移到新部门，是否继续？","提示",{type:"warning"}).then(()=>{F.base.sys.user.move({...b,userIds:w}).then(()=>{var s;I.success("转移成功"),(s=$.value)==null||s.refresh(),W()}).catch(s=>{I.error(s.message),h()})}).catch(()=>null)}}})}return g({open:f}),(w,u)=>{const b=i("cl-form");return y(),S("div",Me,[n(b,{ref_key:"Form",ref:_},null,512)])}}}),De=D({name:"sys-user"}),bt=D({...De,setup(x){const{service:g,refs:F,setRefs:_}=P(),{ViewGroup:$}=Q({title:"用户列表"}),f=N.useCrud({service:g.base.sys.user}),w=N.useTable({columns:[{type:"selection",width:60},{prop:"headImg",label:"头像",component:{name:"cl-avatar"}},{prop:"username",label:"用户名",minWidth:150},{prop:"name",label:"姓名",minWidth:150},{prop:"nickName",label:"昵称",minWidth:150},{prop:"departmentName",label:"部门名称",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:120},{prop:"status",label:"状态",minWidth:120,component:{name:"cl-switch"}},{prop:"phone",label:"手机号码",minWidth:150},{prop:"remark",label:"备注",minWidth:150},{prop:"createTime",label:"创建时间",sortable:"desc",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),u=N.useUpsert({dialog:{width:"800px"},items:[{prop:"headImg",label:"头像",component:{name:"cl-upload",props:{text:"选择头像"}}},{prop:"name",label:"姓名",span:12,required:!0,component:{name:"el-input"}},{prop:"nickName",label:"昵称",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"用户名",required:!0,span:12,component:{name:"el-input"}},()=>{var s;return{prop:"password",label:"密码",span:12,required:((s=u.value)==null?void 0:s.mode)=="add",component:{name:"el-input",props:{type:"password"}},rules:[{min:6,max:16,message:"密码长度在 6 到 16 个字符"}]}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":3}}},{prop:"phone",label:"手机号码",span:12,component:{name:"el-input"}},{prop:"email",label:"邮箱",span:12,component:{name:"el-input"}},{prop:"remark",label:"备注",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"status",label:"状态",value:1,component:{name:"el-radio-group",options:[{label:"开启",value:1},{label:"关闭",value:0}]}}],onSubmit(s,{next:r}){var c,k;r({departmentId:(k=(c=$.value)==null?void 0:c.selected)==null?void 0:k.id,...s})},async onOpen(){g.base.sys.role.list().then(s=>{var r;(r=u.value)==null||r.setOptions("roleIdList",s.map(c=>({label:c.name||"",value:c.id})))})}});function b(s){var r;(r=f.value)==null||r.refresh(s)}function h({id:s}){var r;(r=f.value)==null||r.rowAppend({departmentId:s})}async function W(s){var c;let r=[];s?r=[s.id]:r=((c=w.value)==null?void 0:c.selection.map(k=>k.id))||[],F.userMove.open(r)}return(s,r)=>{const c=i("cl-refresh-btn"),k=i("cl-add-btn"),O=i("cl-multi-delete-btn"),B=i("el-button"),T=i("cl-flex1"),t=i("cl-search-key"),e=i("cl-row"),l=i("el-tag"),o=i("cl-table"),a=i("cl-pagination"),m=i("cl-upsert"),V=i("cl-crud"),R=i("cl-view-group"),U=X("permission");return y(),E(R,{ref_key:"ViewGroup",ref:$},{left:p(()=>[n($e,{onRefresh:b,onUserAdd:h})]),right:p(()=>[n(V,{ref_key:"Crud",ref:f},{default:p(()=>[n(e,null,{default:p(()=>{var d;return[n(c),n(k),n(O),G((y(),E(B,{type:"success",disabled:((d=v(w))==null?void 0:d.selection.length)==0,onClick:r[0]||(r[0]=M=>W())},{default:p(()=>[q("转移")]),_:1},8,["disabled"])),[[U,v(g).base.sys.user.permission.move]]),n(T),n(t,{placeholder:"搜索用户名、姓名"})]}),_:1}),n(e,null,{default:p(()=>[n(o,{ref_key:"Table",ref:w},{"column-roleName":p(({scope:d})=>[d.row.roleName?(y(!0),S(ue,{key:0},de(d.row.roleName.split(","),(M,A)=>(y(),E(l,{key:A,"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"}},{default:p(()=>[q(Y(M),1)]),_:2},1024))),128)):K("",!0)]),"slot-btn":p(({scope:d})=>[G((y(),E(B,{text:"",bg:"",onClick:M=>W(d.row)},{default:p(()=>[q("转移")]),_:2},1032,["onClick"])),[[U,v(g).base.sys.user.permission.move]])]),_:1},512)]),_:1}),n(e,null,{default:p(()=>[n(T),n(a)]),_:1}),n(m,{ref_key:"Upsert",ref:u},null,512),n(Te,{ref:v(_)("userMove")},null,512)]),_:1},512)]),_:1},512)}}});export{bt as default};
