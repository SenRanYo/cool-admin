import{l as ue,w as Z}from"./@vue.runtime-dom-7b7b8a44.js";import{a as de}from"./vuedraggable-7bc20794.js";import{$ as pe,J as ce,u as me,P as fe}from"./@element-plus.icons-vue-e3809a99.js";import{u as ge,i as ye,m as _e,y as he,j as R,o as ve}from"./index-e77a39a7.js";import{u as be}from"./index-8d3b4b42.js";import{I as ke,g as we,a as Ce,b as Se}from"./viewer-16c9b8ac.js";import{r as ee,q as xe}from"./lodash-es-d00cf236.js";import{a as j}from"./element-plus-aceaa6a8.js";import{d as ae,q as v,p as Be,W as w,o as i,c as f,a as B,F as te,b as m,J as g,E as J,M as y,I as b,n as ze,N as $e,L as Ue}from"./@vue.runtime-core-3a9e54b6.js";import{r as Ve,u as o}from"./@vue.reactivity-747ae439.js";import{o as K,O as C}from"./@vue.shared-9aa0355e.js";import{_ as Fe}from"./_plugin-vue_export-helper-c27b6911.js";import"./sortablejs-97dc98f7.js";import"./chardet-ee49d9b4.js";import"./vue-1fcee0a5.js";import"./monaco-editor-9ddaeaf3.js";import"./store-4dd21bbb.js";import"./axios-aba6f0e0.js";import"./nprogress-d2c1a460.js";import"./@vueuse.core-b5ce6112.js";import"./@vueuse.shared-8ce56883.js";import"./mitt-b509fb6d.js";import"./vue-router-19ed6b98.js";import"./pinia-2b0aea45.js";import"./vue-demi-71ba0ef2.js";import"./vue-echarts-c84fbe77.js";import"./resize-detector-a5205554.js";import"./echarts-90e4e057.js";import"./tslib-54e39b60.js";import"./zrender-5c8f9fce.js";import"./mockjs-5923ee6a.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-384ef2e5.js";import"./dayjs-98968027.js";import"./async-validator-dee29e8b.js";import"./memoize-one-297ddbcb.js";import"./escape-html-1d60d822.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-a30dd394.js";import"./@floating-ui.core-a4bcb9d9.js";import"./ts-wps-d32de3c6.js";const Ne={key:0,class:"cl-upload__dragger"},De={key:1,class:"cl-upload__item"},Ie={key:0,class:"cl-upload__text"},qe={key:1,class:"cl-upload__name"},Ae={class:"cl-upload__actions"},Ee={key:2,class:"cl-upload__progress"},Pe={key:3,class:"cl-upload__error"},Le=ae({name:"cl-upload"}),Me=ae({...Le,props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,limitUpload:{type:Boolean,default:!0},size:[String,Number,Array],icon:null,text:String,prefixPath:{type:String,default:"app"},menu:{type:String,default:"base"},showFileList:{type:Boolean,default:!0},draggable:Boolean,drag:Boolean,disabled:Boolean,customClass:String,beforeUpload:Function,isSpace:Boolean,isEdit:null,scope:null,prop:null,isDisabled:Boolean},emits:["update:modelValue","upload","success","error","progress"],setup(r,{expose:oe,emit:S}){const l=r;ue(t=>({"60b8354e":o(G)[0],"60b83510":o(G)[1]}));const{service:I,refs:x,setRefs:z}=be(),{user:le}=ge(),se=ye.useForm(),{options:q}=_e.get("upload"),G=v(()=>{const t=l.size||q.size;return(ee(t)?t:[t,t]).map(e=>xe(e)?e+"px":e)}),$=v(()=>l.isDisabled||l.disabled),A=v(()=>$.value||l.isSpace),W=l.limit||q.limit.upload,E=l.limitSize||q.limit.size,P=v(()=>{if(l.text)return l.text;switch(l.type){case"file":return"选择文件";case"image":return"选择图片"}}),L=v(()=>({Authorization:le.token})),n=Ve([]),U=v(()=>l.accept||(l.type=="file"?"":"image/*")),M=v(()=>l.multiple?!$.value&&W-n.value.length>0:n.value.length==0);function H(t){var e;return l.type=="image"?"image":(e=Se(t))==null?void 0:e.value}async function V(t,e){function u(){const a={type:H(t.name),preload:"",progress:0,url:t.url,uid:t.uid,size:t.size};return a.preload=a.url||(a.type=="image"?window.webkitURL.createObjectURL(t):t.name),a.url||(a.url=a.preload),e?Object.assign(e,a):l.multiple?(M.value||!l.limitUpload)&&n.value.push(a):n.value=[a],S("upload",a),!0}if(l.beforeUpload){const a=l.beforeUpload(t,e,{next:u});return he(a)?a.then(u).catch(()=>null):a&&u(),a}else return t.size/1024/1024>=E?(j.error(`上传文件大小不能超过 ${E}MB!`),!1):u()}function Q(t){n.value.splice(t,1),F()}function X(){n.value=[]}function re(t){var e;(e=x.viewer)==null||e.open(t,n.value)}async function O(t,e){if(e||(e=n.value.find(a=>a.uid==t.file.uid)),!e)return!1;const u=R("");try{let a=u+"_"+t.file.name;const{mode:d,type:k}=await I.base.comm.uploadMode();return new Promise((T,N)=>{async function s({host:p,preview:_,data:Y}){const D=new FormData;for(const c in Y)D.append(c,Y[c]);d=="cloud"&&(a=[l.prefixPath,l.menu,a].filter(Boolean).join("/")),D.append("key",a),D.append("file",t.file),await I.request({url:p,method:"POST",headers:{"Content-Type":"multipart/form-data"},timeout:6e5,data:D,onUploadProgress(c){e.progress=parseInt(String(c.loaded/c.total*100)),S("progress",e)},proxy:d=="local"}).then(c=>{d==="local"?(e.url=c,e.key=c.replace(/^https?:\/\/[^\/]+/,"")):(e.url=`${_||p}/${a}`,e.key=a),e.fileId=u,e.name=e.preload,S("success",e),T(e.url),F()}).catch(c=>{j.error(c.message),e.error=c.message,S("error",e),N(c)})}d=="local"?s({host:"/admin/base/comm/upload"}):I.base.comm.upload().then(p=>{switch(k){case"cos":s({host:p.url,data:p.credentials});break;case"oss":s({host:p.host,data:{OSSAccessKeyId:p.OSSAccessKeyId,policy:p.policy,signature:p.signature}});break;case"qiniu":s({host:p.uploadUrl,preview:p.publicDomain,data:{token:p.token}});break}}).catch(N)})}catch{j.error("上传配置错误")}}function ie(){return n.value.find(t=>t.progress!=100)}function F(){n.value.find(e=>!e.url)||(S("update:modelValue",we(n.value)),ze(()=>{var e;l.prop&&((e=se.value)==null||e.validateField(l.prop))}))}function ne(t){var e,u,a;X(),(e=x.upload)==null||e.clearFiles(),(u=x.upload)==null||u.handleStart(t),(a=x.upload)==null||a.submit()}const h={data:null,open(t){var e;h.data=t,(e=x.space)==null||e.open({limit:t||!l.multiple?1:W})},onConfirm(t){t.forEach(e=>{V({uid:R(),...e},h.data)}),F(),h.data=null}};return Be(()=>l.modelValue,t=>{const e=(ee(t)?t:(t||"").split(",")).filter(Boolean),u=[];n.value=e.map(a=>{const d=n.value.find(k=>a==k.url&&!u.includes(k.uid));return d?(u.push(d.uid),d):{type:H(a),progress:0,uid:R(),url:a,preload:a}}).filter((a,d)=>l.multiple?!0:d==0)},{immediate:!0}),oe({isAdd:M,list:n,check:ie,clear:X,remove:Q,upload:ne}),(t,e)=>{const u=w("el-button"),a=w("el-upload"),d=w("el-icon"),k=w("el-image"),T=w("el-progress"),N=w("cl-upload-space");return i(),f(te,null,[B("div",{class:K(["cl-upload__wrap",[r.customClass]])},[B("div",{class:K(["cl-upload",[`cl-upload--${r.type}`,{"is-disabled":o($),"is-drag":r.drag}]])},[r.drag?y("",!0):(i(),f(te,{key:0},[r.type=="file"?(i(),f("div",{key:0,class:"cl-upload__file-btn",onClick:e[0]||(e[0]=s=>h.open())},[m(a,{ref:o(z)("upload"),drag:r.drag,action:"",accept:o(U),"show-file-list":!1,"before-upload":V,"http-request":O,headers:o(L),multiple:r.multiple,disabled:o(A)},{default:g(()=>[J(t.$slots,"default",{},()=>[m(u,{type:"success"},{default:g(()=>[$e(C(o(P)),1)]),_:1})],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):y("",!0)],64)),r.showFileList?(i(),b(o(de),{key:1,class:"cl-upload__list",tag:"div",modelValue:n.value,"onUpdate:modelValue":e[2]||(e[2]=s=>n.value=s),options:{group:"Upload",animation:300,ghostClass:"Ghost",dragClass:"Drag",draggable:".is-drag",disabled:!r.draggable},"item-key":"uid",onEnd:F},{footer:g(()=>[(r.type=="image"||r.drag)&&o(M)?(i(),f("div",{key:0,class:"cl-upload__footer",onClick:e[1]||(e[1]=s=>h.open())},[m(a,{drag:r.drag,ref:o(z)("upload"),action:"",accept:o(U),"show-file-list":!1,"before-upload":V,"http-request":O,headers:o(L),multiple:r.multiple,disabled:o(A)},{default:g(()=>[J(t.$slots,"default",{},()=>[r.drag?(i(),f("div",Ne,[m(d,null,{default:g(()=>[m(o(pe))]),_:1}),B("div",null," 点击上传或将文件拖动到此处，文件大小限制"+C(o(E))+"M ",1)])):(i(),f("div",De,[m(d,{size:24},{default:g(()=>[r.icon?(i(),b(Ue(r.icon),{key:0})):(i(),b(o(ce),{key:1}))]),_:1}),o(P)?(i(),f("span",Ie,C(o(P)),1)):y("",!0)]))],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):y("",!0)]),item:g(({element:s,index:p})=>[r.showFileList?(i(),b(a,{key:0,action:"",class:"is-drag",accept:o(U),"show-file-list":!1,"http-request":_=>O(_,s),"before-upload":_=>{V(_,s)},headers:o(L),disabled:o(A),onClick:_=>h.open(s)},{default:g(()=>[J(t.$slots,"item",{item:s,index:p},()=>[B("div",{class:K(["cl-upload__item",[`is-${s.type}`]])},[s.type=="image"?(i(),b(k,{key:0,src:s.preload,fit:"cover"},null,8,["src"])):(i(),f("span",qe,C(o(Ce)(s.preload))+"."+C(o(ve)(s.preload)),1)),B("div",Ae,[m(d,{onClick:Z(_=>re(s),["stop"])},{default:g(()=>[m(o(me))]),_:2},1032,["onClick"]),o($)?y("",!0):(i(),b(d,{key:0,onClick:Z(_=>Q(p),["stop"])},{default:g(()=>[m(o(fe))]),_:2},1032,["onClick"]))]),s.progress>0&&s.progress<100?(i(),f("div",Ee,[m(T,{percentage:s.progress,"show-text":!1},null,8,["percentage"])])):y("",!0),s.error?(i(),f("div",Pe,C(s.error),1)):y("",!0)],2)],!0)]),_:2},1032,["accept","http-request","before-upload","headers","disabled","onClick"])):y("",!0)]),_:3},8,["modelValue","options"])):y("",!0)],2)],2),m(ke,{ref:o(z)("viewer")},null,512),r.isSpace?(i(),b(N,{key:0,ref:o(z)("space"),"show-btn":!1,accept:o(U),onConfirm:h.onConfirm},null,8,["accept","onConfirm"])):y("",!0)],64)}}});const $t=Fe(Me,[["__scopeId","data-v-5dd151aa"]]);export{$t as default};
